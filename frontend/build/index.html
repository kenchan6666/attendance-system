<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>员工考勤记录系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 20px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .nav-tabs button {
            padding: 12px 20px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tabs button:hover {
            color: #333;
            background-color: #f9f9f9;
        }

        .nav-tabs button.active {
            color: #1976d2;
            border-bottom-color: #1976d2;
        }

        .main-content {
            min-height: 400px;
        }

        .section {
            background-color: #fafafa;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn-primary,
        .btn-secondary,
        .btn-danger,
        .btn-success {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1565c0;
        }

        .btn-danger {
            background-color: #d32f2f;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c62828;
        }

        .btn-success {
            background-color: #388e3c;
            color: white;
        }

        .btn-success:hover {
            background-color: #2e7d32;
        }

        .status {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .status.success {
            background-color: #c8e6c9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .status.error {
            background-color: #ffcdd2;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .status.info {
            background-color: #bbdefb;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
        }

        table thead {
            background-color: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        table td {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: #555;
        }

        table tbody tr:hover {
            background-color: #f9f9f9;
        }

        .stat-box {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 4px;
            color: #333;
            text-align: center;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .stat-box h3 {
            font-size: 12px;
            margin-bottom: 8px;
            opacity: 0.7;
            text-transform: uppercase;
            font-weight: 600;
        }

        .stat-box .value {
            font-size: 28px;
            font-weight: bold;
        }

        .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        .dev-notice {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .dev-notice strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>员工考勤记录系统</h1>
        </div>

        <!-- <div cSlass="dev-notice">
            <strong>出勤记录系统</strong>
        </div> -->

        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="attendance">出勤操作</button>
            <button class="tab-btn" data-tab="daily-report">日报</button>
            <button class="tab-btn" data-tab="employees">员工列表</button>
            <button class="tab-btn" data-tab="department">部门统计</button>
            <button class="tab-btn" data-tab="ranking">准时率排行</button>
        </nav>

        <main class="main-content">
            <div id="attendance" class="tab-content">
                <div class="section">
                    <h2>出勤操作</h2>
                    <div id="statusMsg" class="status" style="display:none;"></div>
                    <div style="background-color: white; padding: 20px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                        <div class="form-group">
                            <label>员工编号 (输入 "1" 或 "EMP001"):</label>
                            <input type="text" id="empCode" placeholder="输入员工编号或序号" />
                        </div>
                        <div class="button-group">
                            <button onclick="checkIn()" class="btn-primary">签到</button>
                            <button onclick="checkOut()" class="btn-success">签退</button>
                            <button onclick="markAbsent()" class="btn-danger">标记请假</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="daily-report" class="tab-content" style="display:none;">
                <div class="section">
                    <h2>日报</h2>
                    <div class="form-group">
                        <label>选择日期:</label>
                        <input type="date" id="reportDate" />
                    </div>
                    <button onclick="loadDailyReport()" class="btn-primary">加载报表</button>
                    <div id="reportContent" style="margin-top:20px;"></div>
                </div>
            </div>

            <div id="employees" class="tab-content" style="display:none;">
                <div class="section">
                    <h2>员工列表</h2>
                    <button onclick="toggleEmployeeForm()" class="btn-primary toggle-form-btn">+ 创建员工</button>
                    <div id="employeeForm" style="display:none; background-color: white; padding: 20px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                        <div class="form-group">
                            <label>员工编号:</label>
                            <input type="text" id="newEmpCode" placeholder="EMP001" />
                        </div>
                        <div class="form-group">
                            <label>姓名:</label>
                            <input type="text" id="newEmpName" placeholder="输入姓名" />
                        </div>
                        <div class="form-group">
                            <label>邮箱:</label>
                            <input type="email" id="newEmpEmail" placeholder="example@company.com" />
                        </div>
                        <div class="form-group">
                            <label>部门:</label>
                            <select id="newEmpDept">
                                <option>IT</option>
                                <option>HR</option>
                                <option>Finance</option>
                                <option>Operations</option>
                                <option>Sales</option>
                                <option>Marketing</option>
                            </select>
                        </div>
                        <button onclick="createEmployee()" class="btn-success">创建</button>
                    </div>
                    <div id="employeeList"></div>
                </div>
            </div>

            <div id="department" class="tab-content" style="display:none;">
                <div class="section">
                    <h2>部门统计</h2>
                    <div class="form-group">
                        <label>选择部门:</label>
                        <select id="deptSelect">
                            <option>IT</option>
                            <option>HR</option>
                            <option>Finance</option>
                            <option>Operations</option>
                            <option>Sales</option>
                            <option>Marketing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>起始日期:</label>
                        <input type="date" id="deptFromDate" />
                    </div>
                    <div class="form-group">
                        <label>结束日期:</label>
                        <input type="date" id="deptToDate" />
                    </div>
                    <button onclick="loadDepartmentStats()" class="btn-primary">加载统计</button>
                    <div id="deptContent" style="margin-top:20px;"></div>
                </div>
            </div>

            <div id="ranking" class="tab-content" style="display:none;">
                <div class="section">
                    <h2>准时率排行榜</h2>
                    <div class="form-group">
                        <label>起始日期:</label>
                        <input type="date" id="rankFromDate" />
                    </div>
                    <div class="form-group">
                        <label>结束日期:</label>
                        <input type="date" id="rankToDate" />
                    </div>
                    <div class="form-group">
                        <label>显示前几名:</label>
                        <input type="number" id="rankLimit" value="10" min="1" max="50" />
                    </div>
                    <button onclick="loadRanking()" class="btn-primary">加载排行</button>
                    <div id="rankContent" style="margin-top:20px;"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API = 'http://127.0.0.1:8000';

        // 初始化日期
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            document.getElementById('deptFromDate').value = '2025-12-01';
            document.getElementById('deptToDate').value = today;
            document.getElementById('rankFromDate').value = '2025-12-01';
            document.getElementById('rankToDate').value = today;
            loadEmployeeList();
        });

        // 标签页切换
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                e.target.classList.add('active');
                document.getElementById(e.target.dataset.tab).style.display = 'block';
            });
        });

        // 显示状态消息
        function showStatus(msg, type = 'info') {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = `status ${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // 员工编号转换
        function convertToEmployeeCode(input) {
            const trimmed = input.trim().toUpperCase();
            if (trimmed.startsWith('EMP')) return trimmed;
            if (/^\d+$/.test(trimmed)) return 'EMP' + trimmed.padStart(3, '0');
            return trimmed;
        }

        // 签到
        async function checkIn() {
            const code = convertToEmployeeCode(document.getElementById('empCode').value);
            if (!code || code === 'EMP') {
                showStatus('请输入员工编号', 'error');
                return;
            }
            try {
                const res = await fetch(`${API}/attendance/check-in`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employee_code: code })
                });
                const data = await res.json();
                showStatus(`签到成功: ${data.message}`, 'success');
                document.getElementById('empCode').value = '';
            } catch (err) {
                showStatus(`签到失败: ${err.message}`, 'error');
            }
        }

        // 签退
        async function checkOut() {
            const code = convertToEmployeeCode(document.getElementById('empCode').value);
            if (!code || code === 'EMP') {
                showStatus('请输入员工编号', 'error');
                return;
            }
            try {
                const res = await fetch(`${API}/attendance/check-out`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employee_code: code })
                });
                const data = await res.json();
                showStatus(`签退成功: ${data.message}`, 'success');
                document.getElementById('empCode').value = '';
            } catch (err) {
                showStatus(`签退失败: ${err.message}`, 'error');
            }
        }

        // 标记请假
        async function markAbsent() {
            const code = convertToEmployeeCode(document.getElementById('empCode').value);
            if (!code || code === 'EMP') {
                showStatus('请输入员工编号', 'error');
                return;
            }
            try {
                const today = new Date().toISOString().split('T')[0];
                const res = await fetch(`${API}/attendance/mark-absent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employee_code: code, date: today })
                });
                const data = await res.json();
                showStatus(`标记成功: ${data.message}`, 'success');
                document.getElementById('empCode').value = '';
            } catch (err) {
                showStatus(`标记失败: ${err.message}`, 'error');
            }
        }

        // 加载日报
        async function loadDailyReport() {
            const date = document.getElementById('reportDate').value;
            try {
                const res = await fetch(`${API}/reports/daily-summary?report_date=${date}`);
                const data = await res.json();
                let html = '<div class="report-stats">';
                html += `<div class="stat-box"><h3>总人数</h3><div class="value">${data.total_active || 0}</div></div>`;
                html += `<div class="stat-box"><h3>出勤</h3><div class="value">${data.present || 0}</div></div>`;
                html += `<div class="stat-box"><h3>缺勤</h3><div class="value">${data.absent || 0}</div></div>`;
                html += `<div class="stat-box"><h3>迟到</h3><div class="value">${data.late || 0}</div></div>`;
                html += `<div class="stat-box"><h3>请假</h3><div class="value">${data.on_leave || 0}</div></div>`;
                html += `<div class="stat-box"><h3>值班</h3><div class="value">${data.on_duty || 0}</div></div>`;
                html += '</div>';

                if (data.present_employees && data.present_employees.length > 0) {
                    html += '<h3 style="margin-top:20px; margin-bottom:10px;">出勤员工:</h3><ul style="list-style:none;padding:0;">';
                    data.present_employees.forEach(e => {
                        const name = e.full_name || '未知';
                        const code = e.employee_code || '';
                        html += `<li style="padding:8px; border-bottom:1px solid #eee;">${name} ${code ? `(${code})` : ''}</li>`;
                    });
                    html += '</ul>';
                }

                // 迟到员工
                if (data.late_employees && data.late_employees.length > 0) {
                    html += '<h3 style="margin-top:20px; margin-bottom:10px;">迟到员工:</h3><ul style="list-style:none;padding:0;">';
                    data.late_employees.forEach(e => {
                        const name = e.full_name || '未知';
                        const code = e.employee_code || '';
                        html += `<li style="padding:8px; border-bottom:1px solid #eee;">${name} ${code ? `(${code})` : ''}</li>`;
                    });
                    html += '</ul>';
                }

                // 缺勤员工
                if (data.absent_employees && data.absent_employees.length > 0) {
                    html += '<h3 style="margin-top:20px; margin-bottom:10px;">缺勤员工:</h3><ul style="list-style:none;padding:0;">';
                    data.absent_employees.forEach(e => {
                        const name = e.full_name || '未知';
                        const code = e.employee_code || '';
                        html += `<li style="padding:8px; border-bottom:1px solid #eee;">${name} ${code ? `(${code})` : ''}</li>`;
                    });
                    html += '</ul>';
                }

                // 请假员工
                if (data.on_leave_employees && data.on_leave_employees.length > 0) {
                    html += '<h3 style="margin-top:20px; margin-bottom:10px;">请假员工:</h3><ul style="list-style:none;padding:0;">';
                    data.on_leave_employees.forEach(e => {
                        const name = e.full_name || '未知';
                        const code = e.employee_code || '';
                        html += `<li style="padding:8px; border-bottom:1px solid #eee;">${name} ${code ? `(${code})` : ''}</li>`;
                    });
                    html += '</ul>';
                }

                document.getElementById('reportContent').innerHTML = html;
            } catch (err) {
                showStatus(`加载失败: ${err.message}`, 'error');
            }
        }

        // 加载员工列表
        async function loadEmployeeList() {
            try {
                const res = await fetch(`${API}/employees/`);
                const data = await res.json();
                let html = '<table><thead><tr><th>编号</th><th>姓名</th><th>邮箱</th><th>部门</th></tr></thead><tbody>';
                data.forEach(e => {
                    html += `<tr><td>${e.employee_code}</td><td>${e.full_name}</td><td>${e.email}</td><td>${e.department}</td></tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('employeeList').innerHTML = html;
            } catch (err) {
                console.error(err);
            }
        }

        // 创建员工
        async function createEmployee() {
            const code = document.getElementById('newEmpCode').value;
            const name = document.getElementById('newEmpName').value;
            const email = document.getElementById('newEmpEmail').value;
            const dept = document.getElementById('newEmpDept').value;

            if (!code || !name || !email) {
                showStatus('请填写所有字段', 'error');
                return;
            }

            try {
                const res = await fetch(`${API}/employees/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        employee_code: code,
                        full_name: name,
                        email: email,
                        department: dept,
                        position: '员工',
                        hire_date: new Date().toISOString().split('T')[0]
                    })
                });
                const data = await res.json();
                showStatus('员工创建成功', 'success');
                document.getElementById('newEmpCode').value = '';
                document.getElementById('newEmpName').value = '';
                document.getElementById('newEmpEmail').value = '';
                loadEmployeeList();
            } catch (err) {
                showStatus(`创建失败: ${err.message}`, 'error');
            }
        }

        function toggleEmployeeForm() {
            const form = document.getElementById('employeeForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        // 加载部门统计
        async function loadDepartmentStats() {
            const dept = document.getElementById('deptSelect').value;
            const from = document.getElementById('deptFromDate').value;
            const to = document.getElementById('deptToDate').value;

            try {
                const res = await fetch(`${API}/reports/department/${dept}/attendance?date_from=${from}&date_to=${to}`);
                const data = await res.json();
                let html = '<div class="report-stats">';
                html += `<div class="stat-box"><h3>员工总数</h3><div class="value">${data.total_employees}</div></div>`;
                html += `<div class="stat-box"><h3>平均出勤率</h3><div class="value">${data.avg_attendance_rate}%</div></div>`;
                html += `<div class="stat-box late"><h3>总迟到</h3><div class="value">${data.total_late}</div></div>`;
                html += `<div class="stat-box absent"><h3>总缺勤</h3><div class="value">${data.total_absent}</div></div>`;
                html += '</div>';
                document.getElementById('deptContent').innerHTML = html;
            } catch (err) {
                showStatus(`加载失败: ${err.message}`, 'error');
            }
        }

        // 加载排行
        async function loadRanking() {
            const from = document.getElementById('rankFromDate').value;
            const to = document.getElementById('rankToDate').value;
            const limit = document.getElementById('rankLimit').value;

            try {
                const res = await fetch(`${API}/reports/punctuality-ranking?date_from=${from}&date_to=${to}&limit=${limit}`);
                const data = await res.json();
                let html = '<table><thead><tr><th>排名</th><th>编号</th><th>姓名</th><th>出勤率(%)</th><th>迟到次数</th></tr></thead><tbody>';
                data.rankings.forEach((r, idx) => {
                    html += `<tr><td>${idx + 1}</td><td>${r.employee_code}</td><td>${r.employee_name}</td><td>${r.attendance_rate}</td><td>${r.late_count}</td></tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('rankContent').innerHTML = html;
            } catch (err) {
                showStatus(`加载失败: ${err.message}`, 'error');
            }
        }
    </script>
</body>
</html>