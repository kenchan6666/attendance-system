<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>员工考勤记录系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 20px;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .nav-tabs button {
            padding: 12px 20px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tabs button:hover {
            color: #333;
            background-color: #f9f9f9;
        }

        .nav-tabs button.active {
            color: #1976d2;
            border-bottom-color: #1976d2;
        }

        .main-content {
            min-height: 400px;
        }

        .section {
            background-color: #fafafa;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn-primary,
        .btn-secondary,
        .btn-danger,
        .btn-success {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1565c0;
        }

        .btn-danger {
            background-color: #d32f2f;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c62828;
        }

        .btn-success {
            background-color: #388e3c;
            color: white;
        }

        .btn-success:hover {
            background-color: #2e7d32;
        }

        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            margin-right: 5px;
            transition: all 0.2s;
        }

        .btn-small.btn-success {
            background-color: #388e3c;
            color: white;
        }

        .btn-small.btn-success:hover {
            background-color: #2e7d32;
        }

        .btn-small.btn-danger {
            background-color: #d32f2f;
            color: white;
        }

        .btn-small.btn-danger:hover {
            background-color: #c62828;
        }

        .status {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .status.success {
            background-color: #c8e6c9;
            color: #2e7d32;
            border-left: 4px solid #4caf50;
        }

        .status.error {
            background-color: #ffcdd2;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .status.info {
            background-color: #bbdefb;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
        }

        table thead {
            background-color: #f5f5f5;
            border-bottom: 2px solid #ddd;
        }

        table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        table td {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            color: #555;
        }

        table tbody tr:hover {
            background-color: #f9f9f9;
        }

        .stat-box {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 4px;
            color: #333;
            text-align: center;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .stat-box h3 {
            font-size: 12px;
            margin-bottom: 8px;
            opacity: 0.7;
            text-transform: uppercase;
            font-weight: 600;
        }

        .stat-box .value {
            font-size: 28px;
            font-weight: bold;
        }

        .report-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        .dev-notice {
            background-color: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .dev-notice strong {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>员工考勤记录系统</h1>
        </div>

        <!-- <div cSlass="dev-notice">
            <strong>出勤记录系统</strong>
        </div> -->

        <nav class="nav-tabs">
            <button class="tab-btn active" data-tab="attendance">出勤操作</button>
            <button class="tab-btn" data-tab="checked-out">已签退</button>
            <button class="tab-btn" data-tab="daily-report">日报</button>
            <button class="tab-btn" data-tab="employees">员工列表</button>
            <button class="tab-btn" data-tab="department">部门统计</button>
            <button class="tab-btn" data-tab="ranking">准时率排行</button>
            <button class="tab-btn" data-tab="leave-request">请假申请</button>
        </nav>

        <main class="main-content">
            <div id="attendance" class="tab-content">
                <div class="section">
                    <h2>出勤操作</h2>
                    <div id="statusMsg" class="status" style="display:none;"></div>
                    <div style="background-color: white; padding: 20px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                        <div class="form-group">
                            <label>员工编号 (输入 "1" 或 "EMP001"):</label>
                            <input type="text" id="empCode" placeholder="输入员工编号或序号" />
                        </div>
                        <div class="button-group">
                            <button onclick="checkIn()" class="btn-primary">签到</button>
                            <button onclick="checkOut()" class="btn-success">签退</button>
                            <button onclick="markAbsent()" class="btn-danger">标记请假</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="daily-report" class="tab-content" style="display:none;">
                <div class="section">
                    <h2>日报</h2>
                    <div class="form-group">
                        <label>选择日期:</label>
                        <input type="date" id="reportDate" />
                    </div>
                    <button onclick="loadDailyReport()" class="btn-primary">加载报表</button>
                    <div id="reportContent" style="margin-top:20px;"></div>
                </div>
            </div>

            <div id="checked-out" class="tab-content" style="display:none;">
                <div class="section">
                    <h2>已签退员工</h2>
                    <div class="form-group">
                        <label>选择日期:</label>
                        <input type="date" id="checkedOutDate" />
                    </div>
                    <button onclick="loadCheckedOutEmployees()" class="btn-primary">加载已签退员工</button>
                    <div id="checkedOutContent" style="margin-top:20px;"></div>
                </div>
            </div>

            <div id="employees" class="tab-content" style="display:none;">
                <div class="section">
                    <h2>员工列表</h2>
                    <button onclick="toggleEmployeeForm()" class="btn-primary toggle-form-btn">+ 创建员工</button>
                    <div id="employeeForm" style="display:none; background-color: white; padding: 20px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                        <div class="form-group">
                            <label>员工编号:</label>
                            <input type="text" id="newEmpCode" placeholder="EMP001" />
                        </div>
                        <div class="form-group">
                            <label>姓名:</label>
                            <input type="text" id="newEmpName" placeholder="输入姓名" />
                        </div>
                        <div class="form-group">
                            <label>邮箱:</label>
                            <input type="email" id="newEmpEmail" placeholder="example@company.com" />
                        </div>
                        <div class="form-group">
                            <label>部门:</label>
                            <select id="newEmpDept">
                                <option>IT</option>
                                <option>HR</option>
                                <option>Finance</option>
                                <option>Operations</option>
                                <option>Sales</option>
                                <option>Marketing</option>
                            </select>
                        </div>
                        <button onclick="createEmployee()" class="btn-success">创建</button>
                    </div>
                    <div id="editEmployeeForm" style="display:none; background-color: white; padding: 20px; border-radius: 6px; margin: 20px 0; border: 1px solid #e0e0e0;">
                        <h3 style="margin-bottom:15px; color:#333;">编辑员工信息</h3>
                        <div id="editStatus" class="status" style="display:none; margin-bottom:15px;"></div>
                        
                        <input type="hidden" id="editEmpId" />  <!-- 存储员工ID -->
                        
                        <div class="form-group">
                            <label>员工编号:</label>
                            <input type="text" id="editEmpCode" readonly style="background:#f5f5f5;" />
                        </div>
                        <div class="form-group">
                            <label>姓名:</label>
                            <input type="text" id="editEmpName" />
                        </div>
                        <div class="form-group">
                            <label>邮箱:</label>
                            <input type="email" id="editEmpEmail" />
                        </div>
                        <div class="form-group">
                            <label>部门:</label>
                            <select id="editEmpDept">
                                <option>IT</option>
                                <option>HR</option>
                                <option>Finance</option>
                                <option>Operations</option>
                                <option>Sales</option>
                                <option>Marketing</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>职位:</label>
                            <input type="text" id="editEmpPosition" placeholder="可选" />
                        </div>
                        <div class="form-group">
                            <label>入职日期:</label>
                            <input type="date" id="editEmpHireDate" />
                        </div>
                        
                        <div class="button-group">
                            <button onclick="saveEmployeeEdit()" class="btn-success">保存修改</button>
                            <button onclick="cancelEmployeeEdit()" class="btn-danger">取消</button>
                        </div>
                    </div>
                    <div id="employeeList"></div>
                </div>
            </div>

            <div id="department" class="tab-content" style="display:none;">
                <div class="section">
                    <h2>部门统计</h2>
                    <div class="form-group">
                        <label>选择部门:</label>
                        <select id="deptSelect">
                            <option>IT</option>
                            <option>HR</option>
                            <option>Finance</option>
                            <option>Operations</option>
                            <option>Sales</option>
                            <option>Marketing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>起始日期:</label>
                        <input type="date" id="deptFromDate" />
                    </div>
                    <div class="form-group">
                        <label>结束日期:</label>
                        <input type="date" id="deptToDate" />
                    </div>
                    <button onclick="loadDepartmentStats()" class="btn-primary">加载统计</button>
                    <div id="deptContent" style="margin-top:20px;"></div>
                </div>
            </div>

            <div id="ranking" class="tab-content" style="display:none;">
                <div class="section">
                    <h2>准时率排行榜</h2>
                    <div class="form-group">
                        <label>起始日期:</label>
                        <input type="date" id="rankFromDate" />
                    </div>
                    <div class="form-group">
                        <label>结束日期:</label>
                        <input type="date" id="rankToDate" />
                    </div>
                    <div class="form-group">
                        <label>显示前几名:</label>
                        <input type="number" id="rankLimit" value="10" min="1" max="50" />
                    </div>
                    <button onclick="loadRanking()" class="btn-primary">加载排行</button>
                    <div id="rankContent" style="margin-top:20px;"></div>
                </div>
            </div>

            <div id="leave-request" class="tab-content" style="display:none;">
                <!-- 提交请假申请表单 -->
                <div class="section">
                    <h2>提交请假申请</h2>
                    <div id="leaveStatus" class="status" style="display:none;"></div>
                    <div style="background-color: white; padding: 20px; border-radius: 6px; border: 1px solid #e0e0e0;">
                        <div class="form-group">
                            <label>员工编号 (输入 "1" 或 "EMP001"):</label>
                            <input type="text" id="leaveEmpCode" placeholder="输入员工编号或序号" />
                        </div>
                        <div class="form-group">
                            <label>请假类型:</label>
                            <select id="leaveType">
                                <option value="Sick Leave">病假</option>
                                <option value="Annual Leave">年假</option>
                                <option value="Personal Leave">事假</option>
                                <option value="Unpaid Leave">无薪假</option>
                                <option value="Maternity Leave">产假</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>开始日期:</label>
                            <input type="date" id="leaveStartDate" />
                        </div>
                        <div class="form-group">
                            <label>结束日期:</label>
                            <input type="date" id="leaveEndDate" />
                        </div>
                        <div class="form-group">
                            <label>理由:</label>
                            <textarea id="leaveReason" rows="4" placeholder="请填写请假理由"></textarea>
                        </div>
                        <div class="button-group">
                            <button onclick="submitLeaveRequest()" class="btn-primary">提交请假申请</button>
                        </div>
                    </div>
                </div>

                <!-- 请假申请管理 -->
                <div class="section" style="margin-top: 30px;">
                    <h2>请假申请管理</h2>
                    <div style="background-color: white; padding: 20px; border-radius: 6px; border: 1px solid #e0e0e0; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>筛选状态:</label>
                            <select id="leaveStatusFilter">
                                <option value="">全部</option>
                                <option value="Pending">待审批</option>
                                <option value="Approved">已批准</option>
                                <option value="Rejected">已驳回</option>
                            </select>
                        </div>
                        <div class="button-group">
                            <button onclick="loadLeaveRequests()" class="btn-primary">加载请假申请</button>
                        </div>
                    </div>
                    <div id="leaveRequestsContent" style="background-color: white; padding: 20px; border-radius: 6px; border: 1px solid #e0e0e0;"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API = 'http://127.0.0.1:8000';

        // 初始化日期
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
            document.getElementById('checkedOutDate').value = today;
            document.getElementById('deptFromDate').value = '2025-12-01';
            document.getElementById('deptToDate').value = today;
            document.getElementById('rankFromDate').value = '2025-12-01';
            document.getElementById('rankToDate').value = today;
            document.getElementById('leaveStartDate').value = today;
            document.getElementById('leaveEndDate').value = today;
            loadEmployeeList();
        });

        // 标签页切换
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                e.target.classList.add('active');
                document.getElementById(e.target.dataset.tab).style.display = 'block';
            });
        });

        // 显示状态消息
        function showStatus(msg, type = 'info') {
            const el = document.getElementById('statusMsg');
            el.textContent = msg;
            el.className = `status ${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // 员工编号转换
        function convertToEmployeeCode(input) {
            const trimmed = input.trim().toUpperCase();
            if (trimmed.startsWith('EMP')) return trimmed;
            if (/^\d+$/.test(trimmed)) return 'EMP' + trimmed.padStart(3, '0');
            return trimmed;
        }

        // 签到
        async function checkIn() {
            const code = convertToEmployeeCode(document.getElementById('empCode').value);
            if (!code || code === 'EMP') {
                showStatus('请输入员工编号', 'error');
                return;
            }
            try {
                const res = await fetch(`${API}/attendance/check-in`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employee_code: code })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || '签到失败');
                }

                showStatus('签到成功！', 'success');
                document.getElementById('empCode').value = '';
            } catch (err) {
                showStatus(`签到失败: ${err.message}`, 'error');
            }
        }

        // 签退
        async function checkOut() {
            const code = convertToEmployeeCode(document.getElementById('empCode').value);
            if (!code || code === 'EMP') {
                showStatus('请输入员工编号', 'error');
                return;
            }
            try {
                const res = await fetch(`${API}/attendance/check-out`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employee_code: code })
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || '签退失败');
                }
                
                showStatus('签退成功');
                document.getElementById('empCode').value = '';
            } catch (err) {
                showStatus(`签退失败: ${err.message}`, 'error');
            }
        }

        // 标记请假
        async function markAbsent() {
            const code = convertToEmployeeCode(document.getElementById('empCode').value);
            if (!code || code === 'EMP') {
                showStatus('请输入员工编号', 'error');
                return;
            }
            try {
                const today = new Date().toISOString().split('T')[0];
                const res = await fetch(`${API}/attendance/mark-absent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ employee_code: code, date: today })
                });
                const data = await res.json();
                showStatus(`标记成功: ${data.message}`, 'success');
                document.getElementById('empCode').value = '';
            } catch (err) {
                showStatus(`标记失败: ${err.message}`, 'error');
            }
        }

        // 加载日报
        async function loadDailyReport() {
            const date = document.getElementById('reportDate').value;
            try {
                const res = await fetch(`${API}/reports/daily-summary?report_date=${date}`);
                const data = await res.json();
                let html = '<div class="report-stats">';
                html += `<div class="stat-box"><h3>总人数</h3><div class="value">${data.total_active || 0}</div></div>`;
                html += `<div class="stat-box"><h3>出勤</h3><div class="value">${data.present || 0}</div></div>`;
                html += `<div class="stat-box"><h3>缺勤</h3><div class="value">${data.absent || 0}</div></div>`;
                html += `<div class="stat-box"><h3>迟到</h3><div class="value">${data.late || 0}</div></div>`;
                html += `<div class="stat-box"><h3>请假</h3><div class="value">${data.on_leave || 0}</div></div>`;
                html += `<div class="stat-box"><h3>值班</h3><div class="value">${data.on_duty || 0}</div></div>`;
                html += '</div>';

                if (data.present_employees && data.present_employees.length > 0) {
                    html += '<h3 style="margin-top:20px; margin-bottom:10px;">出勤员工:</h3><ul style="list-style:none;padding:0;">';
                    data.present_employees.forEach(e => {
                        const name = e.full_name || '未知';
                        const code = e.employee_code || '';
                        html += `<li style="padding:8px; border-bottom:1px solid #eee;">${name} ${code ? `(${code})` : ''}</li>`;
                    });
                    html += '</ul>';
                }

                // 迟到员工
                if (data.late_employees && data.late_employees.length > 0) {
                    html += '<h3 style="margin-top:20px; margin-bottom:10px;">迟到员工:</h3><ul style="list-style:none;padding:0;">';
                    data.late_employees.forEach(e => {
                        const name = e.full_name || '未知';
                        const code = e.employee_code || '';
                        html += `<li style="padding:8px; border-bottom:1px solid #eee;">${name} ${code ? `(${code})` : ''}</li>`;
                    });
                    html += '</ul>';
                }

                // 缺勤员工
                if (data.absent_employees && data.absent_employees.length > 0) {
                    html += '<h3 style="margin-top:20px; margin-bottom:10px;">缺勤员工:</h3><ul style="list-style:none;padding:0;">';
                    data.absent_employees.forEach(e => {
                        const name = e.full_name || '未知';
                        const code = e.employee_code || '';
                        html += `<li style="padding:8px; border-bottom:1px solid #eee;">${name} ${code ? `(${code})` : ''}</li>`;
                    });
                    html += '</ul>';
                }

                // 请假员工
                if (data.on_leave_employees && data.on_leave_employees.length > 0) {
                    html += '<h3 style="margin-top:20px; margin-bottom:10px;">请假员工:</h3><ul style="list-style:none;padding:0;">';
                    data.on_leave_employees.forEach(e => {
                        const name = e.full_name || '未知';
                        const code = e.employee_code || '';
                        html += `<li style="padding:8px; border-bottom:1px solid #eee;">${name} ${code ? `(${code})` : ''}</li>`;
                    });
                    html += '</ul>';
                }

                document.getElementById('reportContent').innerHTML = html;
            } catch (err) {
                showStatus(`加载失败: ${err.message}`, 'error');
            }
        }

        // 加载已签退员工
        async function loadCheckedOutEmployees() {
            const date = document.getElementById('checkedOutDate').value;
            if (!date) {
                showStatus('请选择日期', 'error');
                return;
            }
            try {
                // 获取该日期的考勤记录（包含员工信息）
                const res = await fetch(`${API}/attendance/?date=${date}`);
                const records = await res.json();
                
                // 筛选出已签退（check_out_time不为null）的记录
                const checkedOut = records.filter(r => r.check_out_time !== null);
                
                let html = '<div class="report-stats">';
                html += `<div class="stat-box"><h3>已签退人数</h3><div class="value">${checkedOut.length}</div></div>`;
                html += '</div>';
                
                if (checkedOut.length > 0) {
                    html += '<table>';
                    html += '<thead><tr><th>员工编号</th><th>员工名字</th><th>签到时间</th><th>签退时间</th><th>工时</th></tr></thead>';
                    html += '<tbody>';
                    
                    checkedOut.forEach(record => {
                        const checkIn = record.check_in_time ? new Date(record.check_in_time).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'}) : '-';
                        const checkOut = record.check_out_time ? new Date(record.check_out_time).toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'}) : '-';
                        const hours = record.working_hours ? record.working_hours.toFixed(2) : '-';
                        html += `<tr>`;
                        html += `<td>${record.employee_code}</td>`;
                        html += `<td>${record.employee_name}</td>`;
                        html += `<td>${checkIn}</td>`;
                        html += `<td>${checkOut}</td>`;
                        html += `<td>${hours}</td>`;
                        html += `</tr>`;
                    });
                    
                    html += '</tbody></table>';
                } else {
                    html += '<p style="color: #999; text-align: center;">该日期暂无已签退的员工</p>';
                }
                
                document.getElementById('checkedOutContent').innerHTML = html;
            } catch (err) {
                showStatus(`加载失败: ${err.message}`, 'error');
            }
        }


        // 加载员工列表
        async function loadEmployeeList() {
            try {
                const res = await fetch(`${API}/employees/`);
                const data = await res.json();
                let html = '<table><thead><tr><th>编号</th><th>姓名</th><th>邮箱</th><th>部门</th></tr></thead><tbody>';
                data.forEach(e => {
                    const isDeactivated = e.is_deactivated ? 'color:#999;background:#f9f9f9;' : '';
                    html += `
                    <tr style="${isDeactivated}">
                        <td>${e.employee_code}</td>
                        <td>${e.full_name}</td>
                        <td>${e.email}</td>
                        <td>${e.department}</td>
                        <td>
                            <button onclick="editEmployeeByCode('${e.employee_code}', '${e.full_name}', '${e.email}', '${e.department}', '${e.position || ''}', '${e.hire_date}')" class="btn-primary" style="padding:4px 8px;font-size:12px;">编辑</button>
                            <button onclick="deactivateEmployeeByCode('${e.employee_code}', '${e.full_name}')" class="btn-danger" style="padding:4px 8px;font-size:12px;margin-left:8px;">离职</button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('employeeList').innerHTML = html;
            } catch (err) {
                console.error(err);
            }
        }

        async function createEmployee() {
            // 获取原始输入
            const rawCode = document.getElementById('newEmpCode').value.trim();
            const name = document.getElementById('newEmpName').value.trim();
            const email = document.getElementById('newEmpEmail').value.trim();
            const dept = document.getElementById('newEmpDept').value;

            // 必填校验
            if (!rawCode || !name || !email) {
                showStatus('请填写员工编号、姓名和邮箱', 'error');
                return;
            }

            // 自动转换编号（如 "10" → "EMP010"，"emp008" → "EMP008"）
            const employee_code = convertToEmployeeCode(rawCode);

            // 可选：前端再校验一次格式（防止用户输入奇怪内容）
            if (!/^EMP\d{3}$/.test(employee_code)) {
                showStatus('员工编号格式错误，请输入类似 EMP001 或 1~999 的数字', 'error');
                return;
            }

            try {
                const res = await fetch(`${API}/employees/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        employee_code: employee_code,   // 使用转换后的
                        full_name: name,
                        email: email,
                        department: dept,
                        position: '员工',
                        hire_date: new Date().toISOString().split('T')[0]
                    })
                });

                if (!res.ok) {
                    // 后端返回错误时，解析 detail 显示具体原因
                    const errorData = await res.json();
                    const errorMsg = errorData.detail 
                        ? (Array.isArray(errorData.detail) 
                            ? errorData.detail.map(d => d.msg).join('; ') 
                            : errorData.detail)
                        : '未知错误';
                    throw new Error(errorMsg);
                }

                showStatus('员工创建成功！', 'success');

                // 清空表单
                document.getElementById('newEmpCode').value = '';
                document.getElementById('newEmpName').value = '';
                document.getElementById('newEmpEmail').value = '';

                // 刷新员工列表
                loadEmployeeList();

            } catch (err) {
                showStatus(`创建失败: ${err.message}`, 'error');
            }
        }

        function toggleEmployeeForm() {
            const form = document.getElementById('employeeForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        // 加载部门统计
        async function loadDepartmentStats() {
            const dept = document.getElementById('deptSelect').value;
            const from = document.getElementById('deptFromDate').value;
            const to = document.getElementById('deptToDate').value;

            try {
                const res = await fetch(`${API}/reports/department/${dept}/attendance?date_from=${from}&date_to=${to}`);
                const data = await res.json();
                let html = '<div class="report-stats">';
                html += `<div class="stat-box"><h3>员工总数</h3><div class="value">${data.total_employees}</div></div>`;
                html += `<div class="stat-box"><h3>平均出勤率</h3><div class="value">${data.avg_attendance_rate}%</div></div>`;
                html += `<div class="stat-box late"><h3>总迟到</h3><div class="value">${data.total_late}</div></div>`;
                html += `<div class="stat-box absent"><h3>总缺勤</h3><div class="value">${data.total_absent}</div></div>`;
                html += '</div>';
                document.getElementById('deptContent').innerHTML = html;
            } catch (err) {
                showStatus(`加载失败: ${err.message}`, 'error');
            }
        }

        // 加载排行
        async function loadRanking() {
            const from = document.getElementById('rankFromDate').value;
            const to = document.getElementById('rankToDate').value;
            const limit = document.getElementById('rankLimit').value;

            try {
                const res = await fetch(`${API}/reports/punctuality-ranking?date_from=${from}&date_to=${to}&limit=${limit}`);
                const data = await res.json();
                let html = '<table><thead><tr><th>排名</th><th>编号</th><th>姓名</th><th>出勤率(%)</th><th>迟到次数</th></tr></thead><tbody>';
                data.rankings.forEach((r, idx) => {
                    html += `<tr><td>${idx + 1}</td><td>${r.employee_code}</td><td>${r.employee_name}</td><td>${r.attendance_rate}</td><td>${r.late_count}</td></tr>`;
                });
                html += '</tbody></table>';
                document.getElementById('rankContent').innerHTML = html;
            } catch (err) {
                showStatus(`加载失败: ${err.message}`, 'error');
            }
        }
        // 提交请假申请
        async function submitLeaveRequest() {
            const rawCode = document.getElementById('leaveEmpCode').value.trim();
            if (!rawCode) {
                showStatusInLeave('请输入员工编号', 'error');
                return;
            }
            const employee_code = convertToEmployeeCode(rawCode);

            const leaveType = document.getElementById('leaveType').value;
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const reason = document.getElementById('leaveReason').value.trim();

            if (!startDate || !endDate) {
                showStatusInLeave('请选择开始和结束日期', 'error');
                return;
            }
            if (startDate > endDate) {
                showStatusInLeave('开始日期不能晚于结束日期', 'error');
                return;
            }
            if (!reason) {
                showStatusInLeave('请填写请假理由', 'error');
                return;
            }

            try {
            const res = await fetch(`${API}/leaves`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    employee_code: employee_code,
                    leave_type: leaveType,
                    start_date: startDate,
                    end_date: endDate,
                    reason: reason
                })
            });

            if (!res.ok) {
                const errorData = await res.json();  // 解析错误 JSON
                throw new Error(errorData.detail || '未知错误');
            }

            showStatusInLeave('请假申请提交成功！等待审批', 'success');

            // 清空表单
            document.getElementById('leaveEmpCode').value = '';
            document.getElementById('leaveStartDate').value = '';
            document.getElementById('leaveEndDate').value = '';
            document.getElementById('leaveReason').value = '';
            
        } catch (err) {
            showStatusInLeave(`提交失败: ${err.message}`, 'error');
        }
        }

        // 加载请假申请列表
        async function loadLeaveRequests() {
            const statusFilter = document.getElementById('leaveStatusFilter').value;
            try {
                let url = `${API}/leaves`;
                if (statusFilter) {
                    url += `?status=${statusFilter}`;
                }
                const res = await fetch(url);
                if (!res.ok) throw new Error('加载失败');
                const leaves = await res.json();

                let html = '';
                if (leaves.length === 0) {
                    html = '<p style="color: #999; text-align: center;">暂无请假申请</p>';
                } else {
                    html = '<table>';
                    html += '<thead><tr><th>员工编号</th><th>员工名字</th><th>请假类型</th><th>开始日期</th><th>结束日期</th><th>天数</th><th>状态</th><th>操作</th></tr></thead>';
                    html += '<tbody>';
                    
                    leaves.forEach(leave => {
                        const leaveId = leave.id;
                        if (!leaveId) {
                            console.warn('无法获取请假申请ID:', leave);
                            return;
                        }
                        
                        const statusBadge = {
                            'Pending': '<span style="color: #ff9800; font-weight: bold;">待审批</span>',
                            'Approved': '<span style="color: #4caf50; font-weight: bold;">已批准</span>',
                            'Rejected': '<span style="color: #f44336; font-weight: bold;">已驳回</span>'
                        }[leave.status] || leave.status;

                        let actions = '';
                        if (leave.status === 'Pending') {
                            actions += `<button onclick="approveLeaveRequest('${leaveId}')" class="btn-small btn-success">批准</button> `;
                            actions += `<button onclick="rejectLeaveRequest('${leaveId}')" class="btn-small btn-danger">驳回</button> `;
                            actions += `<button onclick="deleteLeaveRequest('${leaveId}')" class="btn-small" style="background-color: #999;">删除</button>`;
                        } else {
                            actions = '-';
                        }

                        html += `<tr>`;
                        html += `<td>${leave.employee_code}</td>`;
                        html += `<td>${leave.employee_name}</td>`;
                        html += `<td>${getLeaveTypeLabel(leave.leave_type)}</td>`;
                        html += `<td>${leave.start_date}</td>`;
                        html += `<td>${leave.end_date}</td>`;
                        html += `<td>${leave.total_days}</td>`;
                        html += `<td>${statusBadge}</td>`;
                        html += `<td>${actions}</td>`;
                        html += `</tr>`;
                    });
                    
                    html += '</tbody></table>';
                }
                document.getElementById('leaveRequestsContent').innerHTML = html;
            } catch (err) {
                showStatusInLeave(`加载失败: ${err.message}`, 'error');
            }
        }

        // 获取请假类型的中文标签
        function getLeaveTypeLabel(leaveType) {
            const labels = {
                'Sick Leave': '病假',
                'Annual Leave': '年假',
                'Personal Leave': '事假',
                'Unpaid Leave': '无薪假',
                'Maternity Leave': '产假'
            };
            return labels[leaveType] || leaveType;
        }

        // 批准请假申请
        async function approveLeaveRequest(leaveId) {
            if (!confirm('确认批准该请假申请吗？')) return;
            try {
                const res = await fetch(`${API}/leaves/${encodeURIComponent(leaveId)}/approve`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ approved_by: 1 }) // 暂时使用固定的审批人ID
                });
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail ? (Array.isArray(error.detail) ? error.detail[0].msg : error.detail) : '批准失败');
                }
                const approvedLeave = await res.json();
                showStatusInLeave(`✓ 请假申请已批准，自动生成 ON_LEAVE 记录（${approvedLeave.start_date} ~ ${approvedLeave.end_date}）`, 'success');
                setTimeout(() => loadLeaveRequests(), 1500);
            } catch (err) {
                showStatusInLeave(`批准失败: ${err.message}`, 'error');
            }
        }

        // 驳回请假申请
        async function rejectLeaveRequest(leaveId) {
            if (!confirm('确认驳回该请假申请吗？')) return;
            try {
                const res = await fetch(`${API}/leaves/${encodeURIComponent(leaveId)}/reject`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail ? (Array.isArray(error.detail) ? error.detail[0].msg : error.detail) : '驳回失败');
                }
                const rejectedLeave = await res.json();
                showStatusInLeave(`✗ 请假申请已驳回，状态已更新为 ${rejectedLeave.status}`, 'success');
                setTimeout(() => loadLeaveRequests(), 1500);
            } catch (err) {
                showStatusInLeave(`驳回失败: ${err.message}`, 'error');
            }
        }

        // 删除请假申请（仅限Pending状态）
        async function deleteLeaveRequest(leaveId) {
            if (!confirm('确认删除该请假申请吗？此操作不可撤销。')) return;
            try {
                const res = await fetch(`${API}/leaves/${encodeURIComponent(leaveId)}`, {
                    method: 'DELETE'
                });
                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail ? (Array.isArray(error.detail) ? error.detail[0].msg : error.detail) : '删除失败');
                }
                showStatusInLeave('✓ 请假申请已删除', 'success');
                setTimeout(() => loadLeaveRequests(), 1500);
            } catch (err) {
                showStatusInLeave(`删除失败: ${err.message}`, 'error');
            }
        }

        // 专门用于请假页面的提示（避免和出勤操作的提示冲突）
        function showStatusInLeave(msg, type = 'info') {
            const el = document.getElementById('leaveStatus');
            el.textContent = msg;
            el.className = `status ${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 4000);
        }

        // 点击编辑按钮时填充表单
        async function editEmployeeByCode(code, name, email, dept, position, hireDate) {
            document.getElementById('editEmployeeForm').style.display = 'block';
            
            document.getElementById('editEmpCode').value = code;
            document.getElementById('editEmpName').value = name;
            document.getElementById('editEmpEmail').value = email;
            document.getElementById('editEmpDept').value = dept;
            document.getElementById('editEmpPosition').value = position || '';
            document.getElementById('editEmpHireDate').value = hireDate;
            
            // 存储 employee_code 用于提交
            document.getElementById('editEmpCode').dataset.code = code;  // 用 data 属性存
        }

        // 取消编辑
        function cancelEmployeeEdit() {
            document.getElementById('editEmployeeForm').style.display = 'none';
            document.getElementById('editStatus').style.display = 'none';
        }

        // 保存修改
        async function saveEmployeeEdit() {
            const code = document.getElementById('editEmpCode').value.trim();
            const name = document.getElementById('editEmpName').value.trim();
            const email = document.getElementById('editEmpEmail').value.trim();
            const dept = document.getElementById('editEmpDept').value;
            const position = document.getElementById('editEmpPosition').value.trim();
            const hireDate = document.getElementById('editEmpHireDate').value;

            if (!code || !name || !email || !hireDate) {
                showEditStatus('请填写完整信息', 'error');
                return;
            }

            try {
                const response = await fetch(`${API}/employees/code/${code}`, {  // ← 用 code 路径
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        full_name: name,
                        email: email,
                        department: dept,
                        position: position,
                        hire_date: hireDate
                    })
                });

                if (!response.ok) {
                    let errorMsg = '更新失败';
                    try {
                        const error = await response.json();
                        errorMsg = error.detail || error.message || '更新失败';
                    } catch (e) {
                        errorMsg = `更新失败 (${response.status}): ${response.statusText}`;
                    }
                    throw new Error(errorMsg);
                }

                showEditStatus('员工信息更新成功！', 'success');
                setTimeout(() => {
                    cancelEmployeeEdit();
                    loadEmployeeList();
                }, 1500);

            } catch (err) {
                showEditStatus(`更新失败: ${err.message}`, 'error');
            }
        }

        // 编辑页面的状态提示
        function showEditStatus(msg, type = 'info') {
            const el = document.getElementById('editStatus');
            el.textContent = msg;
            el.className = `status ${type}`;
            el.style.display = 'block';
        }

        async function deactivateEmployeeByCode(code, name) {
            if (!confirm(`确认将员工【${name}】(${code}) 标记为离职？此操作不可逆！`)) {
                return;
            }

            try {
                const res = await fetch(`${API}/employees/code/${code}/deactivate`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.detail || '离职失败');
                }

                alert(`${name} (${code}) 已标记为离职`);
                loadEmployeeList();
            } catch (err) {
                alert(`操作失败: ${err.message}`);
            }
        }
    </script>
</body>
</html>