<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>员工考勤记录系统</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', Arial, sans-serif; background: linear-gradient(to bottom, #f0f2f5, #ffffff); padding: 20px; min-height: 100vh; }
        .container { max-width: 1300px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 10px; font-size: 2.5em; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; font-size: 1.2em; }
        .section { background: #f8f9fa; padding: 25px; border-radius: 8px; margin: 30px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h2 { color: #3498db; margin-bottom: 15px; font-size: 1.8em; }
        input, select, button { padding: 10px; margin: 5px; font-size: 16px; border-radius: 4px; border: 1px solid #ddd; }
        button { background: #3498db; color: white; border: none; cursor: pointer; }
        button:hover { background: #2980b9; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #3498db; color: white; }
        tr:hover { background: #f8f9fa; }
        .btn-small { padding: 6px 12px; font-size: 14px; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219653; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; font-weight: bold; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .report { background: #e8f4fd; padding: 20px; border-radius: 8px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>员工考勤记录系统</h1>
        <p class="subtitle">完整前端管理界面 - 创建 / 管理 / 出勤 / 报告</p>

        <!-- 员工列表 -->
        <div class="section">
            <h2>员工列表</h2>
            <button onclick="loadEmployees()">刷新列表</button>
            <div id="employeesStatus"></div>
            <table id="employeeTable" style="display:none;">
                <thead>
                    <tr>
                        <th>编号</th>
                        <th>姓名</th>
                        <th>部门</th>
                        <th>职位</th>
                        <th>入职日期</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="employeeBody"></tbody>
            </table>
        </div>

        <!-- 创建新员工 -->
        <div class="section">
            <h2>创建新员工</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label>员工编号：</label>
                    <input type="text" id="code" placeholder="EMP001" value="EMP001" style="width:100%;">
                </div>
                <div>
                    <label>姓名：</label>
                    <input type="text" id="name" placeholder="请输入姓名" style="width:100%;">
                </div>
                <div>
                    <label>邮箱：</label>
                    <input type="email" id="email" placeholder="example@company.com" style="width:100%;">
                </div>
                <div>
                    <label>部门：</label>
                    <select id="dept" style="width:100%; padding:10px;">
                        <option value="IT">IT</option>
                        <option value="HR">HR</option>
                        <option value="Finance">Finance</option>
                        <option value="Operations">Operations</option>
                        <option value="Sales">Sales</option>
                        <option value="Marketing">Marketing</option>
                    </select>
                </div>
                <div>
                    <label>职位：</label>
                    <input type="text" id="position" placeholder="如 Developer, Manager" style="width:100%;">
                </div>
                <div>
                    <label>入职日期：</label>
                    <input type="date" id="hire" value="2025-12-30" style="width:100%;">
                </div>
            </div>
            <button onclick="createEmployee()" style="margin-top:20px; padding:15px 30px; font-size:18px;">创建员工</button>
            <div id="createStatus" style="margin-top:15px;"></div>
        </div>

        <!-- 出勤操作 -->
        <div class="section">
            <h2>出勤操作</h2>
            <div style="margin-bottom: 15px;">
                <label>员工编号：</label>
                <input type="text" id="employeeCodeInput" placeholder="输入数字1,2,3...或EMP001" style="width:300px; padding:10px; font-size:16px;">
            </div>
            <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #ddd;">
                <label>日期（标记缺勤）：</label>
                <input type="date" id="absentDate" value="2025-12-30" style="padding:10px; margin-right:10px;">
            </div>
            <button onclick="checkIn()">出勤</button>
            <button onclick="checkOut()">签退</button>
            <button onclick="markAbsent()">标记缺勤</button>
            <div id="attendanceStatus"></div>
        </div>

        <!-- 报告 -->
        <div class="section">
            <h2>报告</h2>
            <input type="date" id="reportDate">
            <button onclick="loadDailyReport()">查看日报</button>
            <button onclick="downloadMonthlyCSV()">下载月报 CSV (2025-12)</button>
            <div id="reportContent" class="report"></div>
        </div>
    </div>

            <!-- 部门统计 -->
    <div class="section">
        <h2>部门出勤统计</h2>
        <select id="deptSelect">
            <option value="IT">IT</option>
            <option value="HR">HR</option>
            <option value="Finance">Finance</option>
            <option value="Operations">Operations</option>
            <option value="Sales">Sales</option>
            <option value="Marketing">Marketing</option>
        </select>
        <input type="date" id="deptFrom" value="2025-12-01">
        <input type="date" id="deptTo" value="2025-12-30">
        <button onclick="loadDepartmentReport()">查看部门报告</button>
        <div id="deptReport" class="report"></div>
    </div>

        <!-- 准时率排行 -->
    <div class="section">
        <h2>准时率排行榜</h2>
        <input type="date" id="rankFrom" value="2025-12-01">
        <input type="date" id="rankTo" value="2025-12-30">
        <input type="number" id="rankLimit" placeholder="显示前几名" value="5" min="1" max="20">
        <button onclick="loadPunctualityRanking()">查看排行</button>
        <div id="rankReport" class="report"></div>
    </div>

    <script>
        const API = 'http://127.0.0.1:8000';
        let employeeList = [];

        // 转换数字或employee_code为标准格式
        function convertToEmployeeCode(input) {
            const trimmed = input.trim().toUpperCase();
            
            // 返回EMP
            if (trimmed.startsWith('EMP')) {
                return trimmed;
            }
            
            // 转换为EMP格式
            if (/^\d+$/.test(trimmed)) {
                return 'EMP' + trimmed.padStart(3, '0');
            }
            
            // 其他情况返回原值
            return trimmed;
        }  // 保存员工列表供出勤功能使用

        async function loadEmployees() {
            const status = document.getElementById('employeesStatus');
            status.innerHTML = '加载中...';
            try {
                const res = await fetch(`${API}/employees/`);
                if (!res.ok) throw new Error(res.status);
                const data = await res.json();
                employeeList = data;  // 保存到全局变量
                status.innerHTML = '';
                const tbody = document.getElementById('employeeBody');
                tbody.innerHTML = '';
                if (data.length === 0) {
                    status.innerHTML = '<p class="warning">还没有员工，请先创建！</p>';
                    document.getElementById('employeeTable').style.display = 'none';
                    return;
                }

                // 不需要维护下拉菜单
                // const select = document.getElementById('checkEmployeeSelect');
                // select.innerHTML = '<option value="">-- 请选择员工 --</option>';
                // data.forEach((emp, index) => {
                //     const option = document.createElement('option');
                //     option.value = emp.id;                          // value 还是 ObjectId（后端需要）
                //     option.textContent = `${index + 1}. ${emp.employee_code} - ${emp.full_name} (${emp.department})`;
                //     select.appendChild(option);
                // });
                
                data.forEach(emp => {
                    const tr = tbody.insertRow();
                    tr.innerHTML = `
                        <td>${emp.employee_code}</td>
                        <td>${emp.full_name}</td>
                        <td>${emp.department}</td>
                        <td>${emp.position}</td>
                        <td>${emp.hire_date}</td>
                        <td>${emp.is_deactivated ? '离职' : '在职'}</td>
                        <td>
                            <button class="btn-small btn-danger" onclick="deactivateEmployee('${emp._id}')">\u505c\u7528</button>
                        </td>
                    `;
                });
                document.getElementById('employeeTable').style.display = 'table';
            } catch (e) {
                status.innerHTML = e;
            }
        }

        
        // 不需要复杂的事件监听器
        async function createEmployee() {
            const data = {
                employee_code: document.getElementById('code').value,
                full_name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                department: document.getElementById('dept').value,
                position: document.getElementById('position').value,
                hire_date: document.getElementById('hire').value
            };
            try {
                const res = await fetch(`${API}/employees/`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (res.ok) {
                    document.getElementById('createStatus').innerHTML = `<p class="success">创建成功！ID: ${result._id}</p>`;
                    loadEmployees();
                } else {
                    document.getElementById('createStatus').innerHTML = `<p class="error">失败：${JSON.stringify(result)}</p>`;
                }
            } catch (e) {
                document.getElementById('createStatus').innerHTML = '<p class="error">连接失败</p>';
            }
        }

        async function deactivateEmployee(id) {
            if (!confirm('确定停用此员工？')) return;
            try {
                const res = await fetch(`${API}/employees/${id}/deactivate`, {method: 'PATCH'});
                const text = await res.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    result = {detail: text};
                }
                if (res.ok) {
                    alert('停用成功');
                    loadEmployees();
                } else {
                    alert('操作失败：' + (result.detail || text));
                }
            } catch (e) {
                alert('操作失败：' + e.message);
            }
        }

        // 不需要复杂的getEmployeeId函数

        async function checkIn() {
            const input = document.getElementById('employeeCodeInput').value.trim();
            if (!input) {
                alert('请输入员工编号');
                return;
            }
            
            const code = convertToEmployeeCode(input);

            try {
                const res = await fetch(`${API}/attendance/check-in`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({employee_code: code})
                });
                
                const text = await res.text();
                let result = {};
                try {
                    result = JSON.parse(text);
                } catch (e) {}
                
                if (res.ok) {
                    alert('签到成功');
                    document.getElementById('attendanceStatus').innerHTML = '<p class="success">签到成功</p>';
                } else {
                    const msg = result.detail || text;
                    alert('签到失败: ' + msg);
                }
            } catch (e) {
                alert('错误: ' + e.message);
            }
        }

        async function checkOut() {
            const input = document.getElementById('employeeCodeInput').value.trim();
            if (!input) {
                alert('请输入员工编号(如EMP001或数字1,2,3..)');
                return;
            }
            
            const code = convertToEmployeeCode(input);
            
            try {
                const res = await fetch(`${API}/attendance/check-out`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({employee_code: code})
                });
                
                const text = await res.text();
                let result = {};
                try {
                    result = JSON.parse(text);
                } catch (e) {}
                
                if (res.ok) {
                    const workHours = result.working_hours || 'N/A';
                    alert('签退成功！工时: ' + workHours + ' 小时');
                    document.getElementById('attendanceStatus').innerHTML = '<p class="success">签退成功！工时: ' + workHours + '小时</p>';
                } else {
                    const msg = result.detail || text;
                    alert('签退失败: ' + msg);
                }
            } catch (e) {
                alert('错误: ' + e.message);
            }
        }

        async function markAbsent() {
            const input = document.getElementById('employeeCodeInput').value.trim();
            if (!input) {
                alert('请输入员工编号(如EMP001或数字1,2,3..)');
                return;
            }
            
            const code = convertToEmployeeCode(input);
            
            const date = document.getElementById('absentDate').value;
            if (!date) {
                alert('请选择日期');
                return;
            }
            
            try {
                const res = await fetch(`${API}/attendance/mark-absent`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({employee_code: code, date: date})
                });
                
                const text = await res.text();
                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    result = {detail: text};
                }
                if (res.ok) {
                    alert('标记缺勤成功');
                    document.getElementById('attendanceStatus').innerHTML = '<p class="success">标记缺勤成功</p>';
                } else {
                    alert('标记缺勤失败：' + (result.detail || text));
                    document.getElementById('attendanceStatus').innerHTML = `<p class="error">失败：${result.detail || text}</p>`;
                }
            } catch (e) {
                console.error('markAbsent error:', e);
                alert('连接失败：' + e.message);
                document.getElementById('attendanceStatus').innerHTML = '<p class="error">连接失败：' + e.message + '</p>';
            }
        }

        async function loadDailyReport() {
            const date = document.getElementById('reportDate').value;
            if (!date) {
                document.getElementById('reportContent').innerHTML = '<p class="error">请选择日期</p>';
                return;
            }

            try {
                const res = await fetch(`${API}/reports/daily-summary?report_date=${date}`);
                if (!res.ok) {
                    const text = await res.text();
                    throw new Error(`HTTP ${res.status}: ${text}`);
                }
                const data = await res.json();

                // 调试：看看后端到底返回了什么（打开 F12 Console 就能看到）
                console.log('日报返回数据:', data);

                let html = `<h3>${data.date || date} 出勤报告</h3>
                    <p>总人数: ${data.total_active || 0} 
                    | 出勤: ${data.present || 0} 
                    | 在岗: ${data.on_duty || 0} 
                    | 缺勤: ${data.absent || 0} 
                    | 迟到: ${data.late || 0} 
                    | 请假: ${data.on_leave || 0}</p>`;

                // 安全渲染名单（防止 undefined）
                const renderList = (key, label) => {
                    if (data[key] && Array.isArray(data[key]) && data[key].length > 0) {
                        html += `<p><strong>${label}：</strong>${data[key].join(', ')}</p>`;
                    }
                };

                renderList('present_employees', '出勤名单');
                renderList('absent_employees', '缺勤名单');
                renderList('late_employees', '迟到名单');
                renderList('on_leave_employees', '请假名单');

                // 如果完全没有名单，至少提示一下
                if (!data.present_employees && !data.absent_employees && !data.late_employees && !data.on_leave_employees) {
                    html += '<p>今日无特殊记录（可能后端未返回名单字段）</p>';
                }

                document.getElementById('reportContent').innerHTML = `<div class="report">${html}</div>`;
            } catch (e) {
                console.error('日报加载错误:', e);
                document.getElementById('reportContent').innerHTML = 
                    `<p class="error">报告加载失败：${e.message || '未知错误，请打开控制台查看详情'}</p>`;
            }
        }

        async function loadDepartmentReport() {
            const dept = document.getElementById('deptSelect').value;
            const from = document.getElementById('deptFrom').value;
            const to = document.getElementById('deptTo').value;
            const out = document.getElementById('deptReport');
            out.innerHTML = '加载中...';
            try {
                const res = await fetch(`${API}/reports/department/${dept}/attendance?date_from=${from}&date_to=${to}`);
                if (!res.ok) throw new Error(res.status);
                const data = await res.json();
                let html = `<h3>${dept} 部门出勤统计 (${from} ~ ${to})</h3>
                    <p>部门总人数: ${data.total_employees || '未知'}</p>
                    <p>总迟到次数: ${data.total_late || 0}</p>
                    <p>总缺勤次数: ${data.total_absent || 0}</p>`;
                
                // 安全处理平均出勤率（如果后端没返回）
                if (data.average_attendance_rate !== undefined) {
                    html += `<p>平均出勤率: ${data.average_attendance_rate.toFixed(2)}%</p>`;
                } else {
                    html += `<p>平均出勤率: 未提供</p>`;
                }
                
                out.innerHTML = `<div class="report">${html}</div>`;
            } catch (e) {
                out.innerHTML = `<p class="error">加载失败: ${e.message}</p>`;
            }
        }

        async function loadPunctualityRanking() {
            const from = document.getElementById('rankFrom').value;
            const to = document.getElementById('rankTo').value;
            const limit = document.getElementById('rankLimit').value || 5;
            const out = document.getElementById('rankReport');
            out.innerHTML = '加载中...';
            try {
                const res = await fetch(`${API}/reports/punctuality-ranking?date_from=${from}&date_to=${to}&limit=${limit}`);
                if (!res.ok) throw new Error(res.status);
                const data = await res.json();
                if (!data.rankings || data.rankings.length === 0) {
                    out.innerHTML = '<p>无排行数据</p>';
                    return;
                }
                let html = `<h3>准时率排行榜 (${from} ~ ${to}) - 前 ${limit} 名</h3>
                    <table>
                        <thead><tr><th>排名</th><th>姓名</th><th>出勤率</th><th>迟到次数</th></tr></thead>
                        <tbody>`;
                data.rankings.forEach((r, i) => {
                    const rate = r.attendance_rate !== undefined ? r.attendance_rate.toFixed(2) : 'N/A';
                    html += `<tr>
                        <td>${i+1}</td>
                        <td>${r.employee_name || '未知'} (${r.employee_code})</td>
                        <td>${rate}%</td>
                        <td>${r.late_count || 0}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
                out.innerHTML = `<div class="report">${html}</div>`;
            } catch (e) {
                out.innerHTML = `<p class="error">加载失败: ${e.message}</p>`;
            }
        }

        function downloadMonthlyCSV() {
            window.open(`${API}/reports/monthly-csv?year=2025&month=12`, '_blank');
        }

        // 页面加载自动刷新
        function initPage() {
            // 设置日期输入框为今天
            const today = new Date();
            const dateString = today.getFullYear() + '-' + 
                              String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                              String(today.getDate()).padStart(2, '0');
            document.getElementById('reportDate').value = dateString;
            
            loadEmployees();
        }
        
        initPage();
    </script>
</body>
</html>